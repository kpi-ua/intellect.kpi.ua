name: .Build intellect.kpi.ua project

env:
  project: 'intellect-kpi-ua'
  tag: ${{ github.sha }}
  tag-latest: 'latest'
  github-registry-url: 'docker.pkg.github.com/kpi-ua/intellect.kpi.ua/'
  dockerhub-organization: 'kpiua/'

on: [push]

jobs:
  build-and-deploy:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Setup .NET Core
      uses: actions/setup-dotnet@v1
      with:
        dotnet-version: 3.1.101

    - name: Build and publish Web App
      run: |
        dotnet build --configuration Release
        dotnet publish ./src/Site/Site.csproj --configuration Release -o ./docker/out
      
    - name: Build Docker images
      run: |
        docker build ./docker --file ./docker/Dockerfile --tag ${{ env.project }}:${{ env.tag }}
        docker build ./docker --file ./docker/Dockerfile --tag ${{ env.project }}:${{ env.tag-latest }}
    
    - name: Docker Auth (Github packages)
      run: docker login -u ${{ secrets.GH_USERNAME }} -p ${{ secrets.GITHUB_TOKEN }} docker.pkg.github.com

    - name: Push Docker images (Github packages)
      run: |
        docker tag ${{ env.project }}:${{ env.tag }} ${{ env.github-registry-url }}${{ env.project }}:${{ env.tag }}
        docker tag ${{ env.project }}:${{ env.tag-latest }} ${{ env.github-registry-url }}${{ env.project }}:${{ env.tag-latest }}
        docker push ${{ env.github-registry-url }}${{ env.project }}:${{ env.tag }}
        docker push ${{ env.github-registry-url }}${{ env.project }}:${{ env.tag-latest }}
        
    - name: Docker Auth (Dockerhub packages)
      run: docker login -u ${{ secrets.DOCKER_HUB_USERNAME }} -p ${{ secrets.DOCKER_HUB_TOKEN }}       
        
    - name: Push Docker images (Dockerhub packages)
      run: |
        docker tag ${{ env.project }}:${{ env.tag }} ${{ env.dockerhub-organization }}${{ env.project }}:${{ env.tag }}
        docker tag ${{ env.project }}:${{ env.tag-latest }} ${{ env.dockerhub-organizationl }}${{ env.project }}:${{ env.tag-latest }}
        docker push ${{ env.dockerhub-organization }}${{ env.project }}:${{ env.tag }}
        docker push ${{ env.dockerhub-organization }}${{ env.project }}:${{ env.tag-latest }}        
      
    
